<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1102945 - FinalTerm</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Noto+Serif+TC:wght@600&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .game-container {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            padding: 40px;
            max-width: 800px;
            width: 100%;
        }
        
        h1 {
            font-family: 'Noto Serif TC', serif;
            font-size: 2.5em;
            text-align: center;
            background: linear-gradient(135deg, #2d3436, #636e72);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        
        .subtitle {
            text-align: center;
            color: #636e72;
            font-size: 0.9em;
            margin-bottom: 30px;
        }
        
        .status-panel {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 30px;
            text-align: center;
            font-size: 1.1em;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(9, 132, 227, 0.3);
            transition: all 0.3s ease;
        }
        
        .status-panel.black-turn {
            background: linear-gradient(135deg, #2d3436, #636e72);
        }
        
        .status-panel.game-over {
            background: linear-gradient(135deg, #d63031, #e17055);
            animation: pulse-glow 1.5s ease-in-out infinite;
        }
        
        .status-panel.warning {
            background: linear-gradient(135deg, #fdcb6e, #e17055);
        }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 4px 15px rgba(214, 48, 49, 0.3); }
            50% { box-shadow: 0 4px 30px rgba(214, 48, 49, 0.6); }
        }
        
        .board-wrapper {
            display: flex;
            justify-content: center;
            margin: 30px 0;
            position: relative;
        }
        
        .board-container {
            position: relative;
            background: linear-gradient(135deg, #daa520, #b8860b);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        #board {
            position: relative;
            width: 432px;
            height: 432px;
            background: #dcb870;
            border: 2px solid #8b6914;
        }
        
        .grid-line {
            position: absolute;
            background: #000;
        }
        
        .grid-line.horizontal {
            width: 100%;
            height: 1.5px;
            left: 0;
        }
        
        .grid-line.vertical {
            height: 100%;
            width: 1.5px;
            top: 0;
        }
        
        .star-point {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #000;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
        
        .intersection {
            position: absolute;
            width: 44px;
            height: 44px;
            transform: translate(-50%, -50%);
            cursor: pointer;
            border-radius: 50%;
            transition: background 0.2s ease;
        }
        
        .intersection:hover:not(.has-stone) {
            background: rgba(0, 0, 0, 0.1);
        }
        
        .stone {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
            animation: placeStone 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        @keyframes placeStone {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }
            60% {
                transform: translate(-50%, -50%) scale(1.15);
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }
        
        .stone.black {
            background: radial-gradient(circle at 35% 35%, #4a4a4a, #000);
            border: 1px solid #000;
        }
        
        .stone.white {
            background: radial-gradient(circle at 35% 35%, #fff, #e0e0e0);
            border: 1px solid #999;
        }
        
        .stone.last-move::after {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            background: rgba(255, 0, 0, 0.6);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .stone.captured {
            animation: captureAnimation 0.5s ease-out forwards;
        }
        
        @keyframes captureAnimation {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.3);
                opacity: 0.5;
            }
            100% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }
        }
        
        .territory-marker {
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: fadeIn 0.3s ease-in;
        }
        
        .territory-marker.black-territory {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(0, 0, 0, 0.6);
        }
        
        .territory-marker.white-territory {
            background: rgba(255, 255, 255, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.8);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        
        .warning-indicator {
            position: absolute;
            width: 50px;
            height: 50px;
            border: 3px solid #d63031;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: warningPulse 1s ease-in-out infinite;
            pointer-events: none;
        }
        
        @keyframes warningPulse {
            0%, 100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0.8;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 0.4;
            }
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        button {
            font-family: 'Noto Sans TC', sans-serif;
            padding: 12px 28px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #0984e3, #74b9ff);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #d63031, #e17055);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #fdcb6e, #ffeaa7);
            color: #2d3436;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #00b894, #55efc4);
            color: white;
        }
        
        .score-board {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 30px 0;
        }
        
        .score-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .score-card:hover {
            transform: translateY(-4px);
        }
        
        .score-card.active {
            box-shadow: 0 6px 20px rgba(9, 132, 227, 0.3);
            border: 2px solid #0984e3;
        }
        
        .score-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .score-stone {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }
        
        .score-stone.black {
            background: radial-gradient(circle at 35% 35%, #4a4a4a, #000);
        }
        
        .score-stone.white {
            background: radial-gradient(circle at 35% 35%, #fff, #e0e0e0);
        }
        
        .score-label {
            font-size: 1.1em;
            font-weight: 600;
            color: #2d3436;
        }
        
        .score-value {
            font-size: 2.5em;
            font-weight: 700;
            color: #0984e3;
            text-align: center;
        }
        
        .score-details {
            font-size: 0.85em;
            color: #636e72;
            margin-top: 8px;
            text-align: center;
        }
        
        .info-panel {
            background: #f5f6fa;
            border-radius: 12px;
            padding: 15px;
            margin-top: 20px;
            font-size: 0.9em;
            color: #2d3436;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #dfe6e9;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-label {
            font-weight: 600;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-title {
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
            color: #2d3436;
        }
        
        .modal-body {
            font-size: 1.1em;
            line-height: 1.8;
            color: #636e72;
            margin-bottom: 30px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        @media (max-width: 768px) {
            .game-container {
                padding: 20px;
            }
            
            #board {
                width: 360px;
                height: 360px;
            }
            
            .stone {
                width: 36px;
                height: 36px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .score-board {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>‰πùË∑ØÂúçÊ£ã Go 9√ó9</h1>
        <div class="subtitle">1102945 - Final Term Project</div>
        
        <div id="status" class="status-panel black-turn">
            üñ§ ÈªëÊ£ãÂÖàÊâãÔºåË´ãÂú®‰∫§ÂèâÈªû‰∏ãÂ≠ê
        </div>
        
        <div class="board-wrapper">
            <div class="board-container">
                <div id="board"></div>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn-primary" onclick="game.undoMove()" id="undoBtn">‚Ü∂ ÊÇîÊ£ã</button>
            <button class="btn-success" onclick="newGame()">üîÑ Êñ∞Â±Ä</button>
            <button class="btn-warning" onclick="game.pass()" id="passBtn">‚è≠ ËÆìÂ≠ê (0/2)</button>
            <button class="btn-primary" onclick="toggleAI()" id="aiBtn">ü§ñ AI: ÈñãÂïü</button>
            <button class="btn-danger" onclick="game.endGameManually()">üèÅ ÁµÇÂ±Ä</button>
        </div>
        
        <div class="score-board">
            <div class="score-card" id="blackCard">
                <div class="score-header">
                    <div class="score-stone black"></div>
                    <div class="score-label">ÈªëÊ£ã (Áé©ÂÆ∂)</div>
                </div>
                <div class="score-value" id="blackScore">0</div>
                <div class="score-details">
                    <div>Ê¥ªÊ£ã: <span id="blackStones">0</span> Â≠ê</div>
                    <div>ÂúçÂú∞: <span id="blackTerritory">0</span> ÁõÆ</div>
                </div>
            </div>
            
            <div class="score-card" id="whiteCard">
                <div class="score-header">
                    <div class="score-stone white"></div>
                    <div class="score-label">ÁôΩÊ£ã (AI)</div>
                </div>
                <div class="score-value" id="whiteScore">0</div>
                <div class="score-details">
                    <div>Ê¥ªÊ£ã: <span id="whiteStones">0</span> Â≠ê</div>
                    <div>ÂúçÂú∞: <span id="whiteTerritory">0</span> ÁõÆ</div>
                </div>
            </div>
        </div>
        
        <div class="info-panel">
            <div class="info-row">
                <span class="info-label">ÈÅäÊà≤Ë¶èÂâá</span>
                <span>ÈõôÊñπÈÄ£Á∫åËÆìÂ≠êÊàñÁÑ°ÂêàÊ≥ïÊ£ãÊ≠•ÂâáÁµÇÂ±Ä</span>
            </div>
            <div class="info-row">
                <span class="info-label">ÂãùÂà©Ê¢ù‰ª∂</span>
                <span>‰πùË∑ØÊ£ãÁõ§81ÁõÆÔºå‚â•41ÁõÆÁç≤Âãù</span>
            </div>
            <div class="info-row">
                <span class="info-label">ÂõûÂêàÊï∏</span>
                <span id="moveCount">0</span>
            </div>
            <div class="info-row">
                <span class="info-label">ÊèêÂ≠êÊï∏</span>
                <span>Èªë <span id="blackCaptures">0</span> : ÁôΩ <span id="whitCaptures">0</span></span>
            </div>
        </div>
    </div>
    
    <div id="gameOverModal" class="modal">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle">ÈÅäÊà≤ÁµêÊùü</div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer">
                <button class="btn-success" onclick="closeModal(); newGame();">ÈñãÂßãÊñ∞Â±Ä</button>
                <button class="btn-primary" onclick="closeModal()">Êü•ÁúãÊ£ãÁõ§</button>
            </div>
        </div>
    </div>

    <script>
        class NineBoardGo {
            constructor() {
                this.BOARD_SIZE = 9;
                this.CELL_SIZE = 48;
                this.board = Array(9).fill().map(() => Array(9).fill(0));
                this.currentPlayer = 1;  // 1=Èªë, -1=ÁôΩ
                this.gameHistory = [];
                this.moveHistory = [];
                this.consecutivePasses = 0;
                this.aiEnabled = true;
                this.gameOver = false;
                this.lastMove = null;
                this.blackCaptures = 0;
                this.whiteCaptures = 0;
                this.moveCount = 0;
                this.initBoard();
                this.updateStatus();
                this.updateScores();
            }

            initBoard() {
                const boardEl = document.getElementById('board');
                boardEl.innerHTML = '';
                
                // Áπ™Ë£ΩÊ†ºÁ∑ö
                for (let i = 0; i < 9; i++) {
                    // Ê©´Á∑ö
                    const hLine = document.createElement('div');
                    hLine.className = 'grid-line horizontal';
                    hLine.style.top = `${i * this.CELL_SIZE}px`;
                    boardEl.appendChild(hLine);
                    
                    // Ë±éÁ∑ö
                    const vLine = document.createElement('div');
                    vLine.className = 'grid-line vertical';
                    vLine.style.left = `${i * this.CELL_SIZE}px`;
                    boardEl.appendChild(vLine);
                }
                
                // Áπ™Ë£ΩÊòü‰Ωç
                const starPoints = [
                    [2, 2], [2, 6], [6, 2], [6, 6], [4, 4]
                ];
                starPoints.forEach(([row, col]) => {
                    const star = document.createElement('div');
                    star.className = 'star-point';
                    star.style.left = `${col * this.CELL_SIZE}px`;
                    star.style.top = `${row * this.CELL_SIZE}px`;
                    boardEl.appendChild(star);
                });
                
                // ÂâµÂª∫‰∫§ÂèâÈªû
                for (let row = 0; row < 9; row++) {
                    for (let col = 0; col < 9; col++) {
                        const intersection = document.createElement('div');
                        intersection.className = 'intersection';
                        intersection.dataset.row = row;
                        intersection.dataset.col = col;
                        intersection.style.left = `${col * this.CELL_SIZE}px`;
                        intersection.style.top = `${row * this.CELL_SIZE}px`;
                        intersection.addEventListener('click', (e) => this.handleClick(e));
                        boardEl.appendChild(intersection);
                    }
                }
            }

            handleClick(e) {
                if (this.currentPlayer !== 1 || this.gameOver) return;
                
                const row = parseInt(e.currentTarget.dataset.row);
                const col = parseInt(e.currentTarget.dataset.col);
                
                if (this.isValidMove(row, col)) {
                    this.makeMove(row, col, 1);
                    this.consecutivePasses = 0;
                    this.updatePassButton();
                    
                    if (this.aiEnabled && !this.gameOver) {
                        setTimeout(() => this.aiMove(), 500);
                    }
                } else {
                    this.showInvalidMoveWarning(row, col);
                }
            }

            showInvalidMoveWarning(row, col) {
                const boardEl = document.getElementById('board');
                const warning = document.createElement('div');
                warning.className = 'warning-indicator';
                warning.style.left = `${col * this.CELL_SIZE}px`;
                warning.style.top = `${row * this.CELL_SIZE}px`;
                boardEl.appendChild(warning);
                
                setTimeout(() => warning.remove(), 1000);
                
                const statusEl = document.getElementById('status');
                const originalText = statusEl.innerHTML;
                const originalClass = statusEl.className;
                statusEl.innerHTML = '‚ö†Ô∏è Ê≠§‰ΩçÁΩÆÁÑ°Ê∞£ÊàñÈÅïÂèçË¶èÂâáÔºÅ';
                statusEl.className = 'status-panel warning';
                
                setTimeout(() => {
                    statusEl.innerHTML = originalText;
                    statusEl.className = originalClass;
                }, 1500);
            }

            isValidMove(row, col) {
                return this.isValidMoveForPlayer(row, col, this.currentPlayer);
            }

            isValidMoveForPlayer(row, col, player) {
                if (this.board[row][col] !== 0) return false;
                
                // Âª∫Á´ãËá®ÊôÇÊ£ãÁõ§Ê∏¨Ë©¶
                const tempBoard = this.board.map(r => [...r]);
                tempBoard[row][col] = player;
                const opponent = -player;
                
                // Ê™¢Êü•ÊòØÂê¶ËÉΩÊèêÂ≠ê
                const dirs = [[-1,0],[1,0],[0,-1],[0,1]];
                for (let [dr, dc] of dirs) {
                    const nr = row + dr, nc = col + dc;
                    if (nr >= 0 && nr < 9 && nc >= 0 && nc < 9 && tempBoard[nr][nc] === opponent) {
                        if (!this.hasLiberties(tempBoard, nr, nc, opponent)) {
                            return true; // ÂèØ‰ª•ÊèêÂ≠ê
                        }
                    }
                }
                
                // Ê™¢Êü•Ëá™Ë∫´ÊòØÂê¶ÊúâÊ∞£
                return this.hasLiberties(tempBoard, row, col, player);
            }

            hasLiberties(board, row, col, player) {
                const visited = Array(9).fill().map(() => Array(9).fill(false));
                return this.dfsLiberties(board, row, col, player, visited);
            }

            dfsLiberties(board, row, col, player, visited) {
                if (row < 0 || row >= 9 || col < 0 || col >= 9) return false;
                if (visited[row][col]) return false;
                if (board[row][col] !== player) return board[row][col] === 0;
                
                visited[row][col] = true;
                
                const dirs = [[-1,0],[1,0],[0,-1],[0,1]];
                for (let [dr, dc] of dirs) {
                    if (this.dfsLiberties(board, row + dr, col + dc, player, visited)) {
                        return true;
                    }
                }
                return false;
            }

            makeMove(row, col, player) {
                this.board[row][col] = player;
                this.moveCount++;
                this.lastMove = {row, col};
                this.moveHistory.push({
                    board: this.board.map(r => [...r]),
                    row, col, player,
                    blackCaptures: this.blackCaptures,
                    whiteCaptures: this.whiteCaptures
                });
                
                // Ê™¢Êü•‰∏¶ÊèêÂèñÂ∞çÊñπÊ£ãÂ≠ê
                const opponent = -player;
                const dirs = [[-1,0],[1,0],[0,-1],[0,1]];
                let capturedStones = 0;
                
                for (let [dr, dc] of dirs) {
                    const r = row + dr, c = col + dc;
                    if (r >= 0 && r < 9 && c >= 0 && c < 9 && this.board[r][c] === opponent) {
                        if (!this.hasLiberties(this.board, r, c, opponent)) {
                            capturedStones += this.removeGroup(r, c, opponent);
                        }
                    }
                }
                
                if (capturedStones > 0) {
                    if (player === 1) {
                        this.blackCaptures += capturedStones;
                    } else {
                        this.whiteCaptures += capturedStones;
                    }
                }
                
                this.currentPlayer = -player;
                this.updateBoardDisplay();
                this.updateScores();
                this.updateStatus();
                this.checkAtari();
            }

            removeGroup(row, col, player) {
                const visited = Array(9).fill().map(() => Array(9).fill(false));
                const toRemove = [];
                this.findGroup(row, col, player, visited, toRemove);
                
                // ÂãïÁï´ÊèêÂ≠ê
                toRemove.forEach(({r, c}) => {
                    const stone = document.querySelector(`.stone[data-row="${r}"][data-col="${c}"]`);
                    if (stone) {
                        stone.classList.add('captured');
                        setTimeout(() => stone.remove(), 500);
                    }
                    this.board[r][c] = 0;
                });
                
                return toRemove.length;
            }

            findGroup(row, col, player, visited, result) {
                if (row < 0 || row >= 9 || col < 0 || col >= 9) return;
                if (visited[row][col] || this.board[row][col] !== player) return;
                
                visited[row][col] = true;
                result.push({r: row, c: col});
                
                const dirs = [[-1,0],[1,0],[0,-1],[0,1]];
                for (let [dr, dc] of dirs) {
                    this.findGroup(row + dr, col + dc, player, visited, result);
                }
            }

            checkAtari() {
                // Ê™¢Êü•Âè´ÂêÉË≠¶Âëä
                const warnings = [];
                for (let r = 0; r < 9; r++) {
                    for (let c = 0; c < 9; c++) {
                        if (this.board[r][c] === this.currentPlayer) {
                            const liberties = this.countLiberties(r, c, this.currentPlayer);
                            if (liberties === 1) {
                                warnings.push({r, c});
                            }
                        }
                    }
                }
                
                // ÁßªÈô§ËàäË≠¶Âëä
                document.querySelectorAll('.warning-indicator').forEach(el => el.remove());
                
                // È°ØÁ§∫Êñ∞Ë≠¶Âëä
                warnings.forEach(({r, c}) => {
                    const boardEl = document.getElementById('board');
                    const warning = document.createElement('div');
                    warning.className = 'warning-indicator';
                    warning.style.left = `${c * this.CELL_SIZE}px`;
                    warning.style.top = `${r * this.CELL_SIZE}px`;
                    boardEl.appendChild(warning);
                });
            }

            countLiberties(row, col, player) {
                const visited = Array(9).fill().map(() => Array(9).fill(false));
                const liberties = new Set();
                this.findLiberties(row, col, player, visited, liberties);
                return liberties.size;
            }

            findLiberties(row, col, player, visited, liberties) {
                if (row < 0 || row >= 9 || col < 0 || col >= 9) return;
                if (visited[row][col]) return;
                
                if (this.board[row][col] === 0) {
                    liberties.add(`${row},${col}`);
                    return;
                }
                
                if (this.board[row][col] !== player) return;
                
                visited[row][col] = true;
                const dirs = [[-1,0],[1,0],[0,-1],[0,1]];
                for (let [dr, dc] of dirs) {
                    this.findLiberties(row + dr, col + dc, player, visited, liberties);
                }
            }

            updateBoardDisplay() {
                // ÁßªÈô§ÊâÄÊúâÊ£ãÂ≠ê
                document.querySelectorAll('.stone').forEach(el => el.remove());
                document.querySelectorAll('.territory-marker').forEach(el => el.remove());
                
                const boardEl = document.getElementById('board');
                
                // ÈáçÊñ∞Áπ™Ë£ΩÊ£ãÂ≠ê
                for (let row = 0; row < 9; row++) {
                    for (let col = 0; col < 9; col++) {
                        if (this.board[row][col] !== 0) {
                            const stone = document.createElement('div');
                            stone.className = `stone ${this.board[row][col] === 1 ? 'black' : 'white'}`;
                            stone.dataset.row = row;
                            stone.dataset.col = col;
                            stone.style.left = `${col * this.CELL_SIZE}px`;
                            stone.style.top = `${row * this.CELL_SIZE}px`;
                            
                            if (this.lastMove && row === this.lastMove.row && col === this.lastMove.col) {
                                stone.classList.add('last-move');
                            }
                            
                            boardEl.appendChild(stone);
                        }
                    }
                }
                
                // Êõ¥Êñ∞‰∫§ÂèâÈªûÁãÄÊÖã
                document.querySelectorAll('.intersection').forEach(int => {
                    const row = parseInt(int.dataset.row);
                    const col = parseInt(int.dataset.col);
                    if (this.board[row][col] !== 0) {
                        int.classList.add('has-stone');
                    } else {
                        int.classList.remove('has-stone');
                    }
                });
            }

            hasValidMoves(player) {
                for (let r = 0; r < 9; r++) {
                    for (let c = 0; c < 9; c++) {
                        if (this.isValidMoveForPlayer(r, c, player)) return true;
                    }
                }
                return false;
            }

            pass() {
                if (this.gameOver) return;
                
                this.consecutivePasses++;
                this.updatePassButton();
                
                // ÈõôÊñπÈÄ£Á∫åËÆìÂ≠ê
                if (this.consecutivePasses >= 2) {
                    this.endGame('ÈõôÊñπÈÄ£Á∫åËÆìÂ≠ê2Ê¨°');
                    return;
                }
                
                // Ê™¢Êü•ÈõôÊñπÊòØÂê¶ÈÉΩÁÑ°ÂêàÊ≥ïÊ£ãÊ≠•
                if (!this.hasValidMoves(1) && !this.hasValidMoves(-1)) {
                    this.endGame('ÈõôÊñπÂÖ®ÁÑ°ÂêàÊ≥ïÊ£ãÊ≠•');
                    return;
                }
                
                this.currentPlayer = -this.currentPlayer;
                this.updateStatus();
                
                if (this.aiEnabled && this.currentPlayer === -1) {
                    setTimeout(() => this.aiMove(), 500);
                }
            }

            updatePassButton() {
                const btn = document.getElementById('passBtn');
                btn.textContent = `‚è≠ ËÆìÂ≠ê (${this.consecutivePasses}/2)`;
            }

            aiMove() {
                if (this.currentPlayer !== -1 || !this.aiEnabled || this.gameOver) return;
                
                if (!this.hasValidMoves(-1)) {
                    this.pass();
                    return;
                }
                
                const moves = [];
                for (let r = 0; r < 9; r++) {
                    for (let c = 0; c < 9; c++) {
                        if (this.isValidMoveForPlayer(r, c, -1)) {
                            moves.push({row: r, col: c, score: this.evaluateMove(r, c)});
                        }
                    }
                }
                
                if (moves.length > 0) {
                    moves.sort((a, b) => b.score - a.score);
                    const topMoves = moves.filter(m => m.score >= moves[0].score - 5);
                    const chosen = topMoves[Math.floor(Math.random() * Math.min(3, topMoves.length))];
                    this.makeMove(chosen.row, chosen.col, -1);
                    this.consecutivePasses = 0;
                    this.updatePassButton();
                } else {
                    this.pass();
                }
            }

            evaluateMove(row, col) {
                let score = 0;
                
                // Êòü‰Ωç
                if ((row === 2 || row === 6) && (col === 2 || col === 6)) score += 15;
                if (row === 4 && col === 4) score += 20;
                
                // ÈÇäÂíåËßí
                if ((row === 0 || row === 8) && (col === 0 || col === 8)) score += 12;
                if (row === 0 || row === 8 || col === 0 || col === 8) score += 8;
                
                // Èù†ËøëÂ∞çÊñπÊ£ãÂ≠ê
                const dirs = [[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[-1,1],[1,-1],[1,1]];
                for (let [dr, dc] of dirs) {
                    const nr = row + dr, nc = col + dc;
                    if (nr >= 0 && nr < 9 && nc >= 0 && nc < 9) {
                        if (this.board[nr][nc] === 1) score += 5;
                        if (this.board[nr][nc] === -1) score += 3;
                    }
                }
                
                // Ê™¢Êü•ÊòØÂê¶ËÉΩÊèêÂ≠ê
                const tempBoard = this.board.map(r => [...r]);
                tempBoard[row][col] = -1;
                for (let [dr, dc] of dirs.slice(0, 4)) {
                    const nr = row + dr, nc = col + dc;
                    if (nr >= 0 && nr < 9 && nc >= 0 && nc < 9 && tempBoard[nr][nc] === 1) {
                        if (!this.hasLiberties(tempBoard, nr, nc, 1)) {
                            score += 30; // Â§ßÂπÖÊèêÈ´òÊèêÂ≠êÊ¨äÈáç
                        }
                    }
                }
                
                // ÈñãÊîæÂ∫¶
                let emptyNeighbors = 0;
                for (let [dr, dc] of dirs) {
                    const nr = row + dr, nc = col + dc;
                    if (nr >= 0 && nr < 9 && nc >= 0 && nc < 9 && this.board[nr][nc] === 0) {
                        emptyNeighbors++;
                    }
                }
                score += emptyNeighbors * 2;
                
                return score;
            }

            updateStatus() {
                if (this.gameOver) return;
                
                const statusEl = document.getElementById('status');
                const canMove = this.hasValidMoves(this.currentPlayer);
                const opponentCanMove = this.hasValidMoves(-this.currentPlayer);
                const playerName = this.currentPlayer === 1 ? 'üñ§ ÈªëÊ£ã' : '‚ö™ ÁôΩÊ£ã';
                
                // Êõ¥Êñ∞Ë®àÂàÜÂç°È´ò‰∫Æ
                document.getElementById('blackCard').classList.toggle('active', this.currentPlayer === 1);
                document.getElementById('whiteCard').classList.toggle('active', this.currentPlayer === -1);
                
                if (canMove) {
                    statusEl.innerHTML = `${playerName} ÂõûÂêà - ${this.currentPlayer === 1 ? 'Ë´ãÂú®‰∫§ÂèâÈªû‰∏ãÂ≠ê' : 'AIÊÄùËÄÉ‰∏≠...'}`;
                    statusEl.className = this.currentPlayer === 1 ? 'status-panel black-turn' : 'status-panel';
                } else if (!opponentCanMove) {
                    statusEl.innerHTML = '‚ö†Ô∏è ÈõôÊñπÂÖ®ÁÑ°ÂêàÊ≥ïÊ£ãÊ≠•ÔºåÂç≥Â∞áËá™ÂãïÁµÇÂ±Ä';
                    statusEl.className = 'status-panel warning';
                    setTimeout(() => this.endGame('ÈõôÊñπÂÖ®ÁÑ°ÂêàÊ≥ïÊ£ãÊ≠•'), 1500);
                } else {
                    statusEl.innerHTML = `${playerName} ÁÑ°ÂêàÊ≥ïÊ£ãÊ≠•ÔºåËá™ÂãïËÆìÂ≠ê`;
                    statusEl.className = 'status-panel warning';
                    setTimeout(() => this.pass(), 1500);
                }
            }

            endGameManually() {
                if (this.gameOver) return;
                this.endGame('Áé©ÂÆ∂ÊâãÂãïÁµÇÂ±Ä');
            }

            endGame(reason = '') {
                this.gameOver = true;
                document.getElementById('undoBtn').disabled = true;
                document.getElementById('passBtn').disabled = true;
                
                // Ë®àÁÆóÊúÄÁµÇÂàÜÊï∏
                const result = this.calculateFinalScore();
                
                const statusEl = document.getElementById('status');
                statusEl.className = 'status-panel game-over';
                statusEl.innerHTML = `üèÅ ÈÅäÊà≤ÁµêÊùü - ${reason}`;
                
                // È°ØÁ§∫ÁµêÊûúÊ®°ÊÖãÊ°Ü
                this.showGameOverModal(result, reason);
                
                // È°ØÁ§∫ÂúçÂú∞
                this.displayTerritories(result.territories);
            }

            calculateFinalScore() {
                let blackStones = 0, whiteStones = 0;
                
                // Ë®àÁÆóÊ¥ªÊ£ã
                for (let r = 0; r < 9; r++) {
                    for (let c = 0; c < 9; c++) {
                        if (this.board[r][c] === 1) blackStones++;
                        else if (this.board[r][c] === -1) whiteStones++;
                    }
                }
                
                // Ë®àÁÆóÂúçÂú∞
                const visited = Array(9).fill().map(() => Array(9).fill(false));
                let blackTerritory = 0, whiteTerritory = 0;
                const territories = [];
                
                for (let r = 0; r < 9; r++) {
                    for (let c = 0; c < 9; c++) {
                        if (this.board[r][c] === 0 && !visited[r][c]) {
                            const territory = this.calculateTerritory(r, c, visited);
                            territories.push(territory);
                            
                            if (territory.owner === 1) {
                                blackTerritory += territory.size;
                            } else if (territory.owner === -1) {
                                whiteTerritory += territory.size;
                            }
                        }
                    }
                }
                
                const blackTotal = blackStones + blackTerritory;
                const whiteTotal = whiteStones + whiteTerritory;
                
                return {
                    blackStones, whiteStones,
                    blackTerritory, whiteTerritory,
                    blackTotal, whiteTotal,
                    winner: blackTotal > whiteTotal ? 1 : (whiteTotal > blackTotal ? -1 : 0),
                    margin: Math.abs(blackTotal - whiteTotal),
                    territories
                };
            }

            calculateTerritory(r, c, visited) {
                const stack = [{r, c}];
                const points = [];
                let blackBorder = 0, whiteBorder = 0;
                const dirs = [[-1,0],[1,0],[0,-1],[0,1]];
                
                while (stack.length > 0) {
                    const {r: row, c: col} = stack.pop();
                    
                    if (row < 0 || row >= 9 || col < 0 || col >= 9) continue;
                    if (visited[row][col] || this.board[row][col] !== 0) continue;
                    
                    visited[row][col] = true;
                    points.push({r: row, c: col});
                    
                    for (let [dr, dc] of dirs) {
                        const nr = row + dr, nc = col + dc;
                        if (nr >= 0 && nr < 9 && nc >= 0 && nc < 9) {
                            if (this.board[nr][nc] === 1) blackBorder++;
                            else if (this.board[nr][nc] === -1) whiteBorder++;
                            else if (!visited[nr][nc]) {
                                stack.push({r: nr, c: nc});
                            }
                        }
                    }
                }
                
                let owner = 0;
                if (blackBorder > 0 && whiteBorder === 0) owner = 1;
                else if (whiteBorder > 0 && blackBorder === 0) owner = -1;
                
                return {
                    size: points.length,
                    owner,
                    points,
                    blackBorder,
                    whiteBorder
                };
            }

            displayTerritories(territories) {
                const boardEl = document.getElementById('board');
                
                territories.forEach(territory => {
                    if (territory.owner !== 0) {
                        territory.points.forEach(({r, c}) => {
                            const marker = document.createElement('div');
                            marker.className = `territory-marker ${territory.owner === 1 ? 'black-territory' : 'white-territory'}`;
                            marker.style.left = `${c * this.CELL_SIZE}px`;
                            marker.style.top = `${r * this.CELL_SIZE}px`;
                            boardEl.appendChild(marker);
                        });
                    }
                });
            }

            showGameOverModal(result, reason) {
                const modal = document.getElementById('gameOverModal');
                const title = document.getElementById('modalTitle');
                const body = document.getElementById('modalBody');
                
                const winnerText = result.winner === 1 ? 'üñ§ ÈªëÊ£ãÁç≤ÂãùÔºÅ' : 
                                  result.winner === -1 ? '‚ö™ ÁôΩÊ£ãÁç≤ÂãùÔºÅ' : '‚öñÔ∏è Âπ≥ÊâãÔºÅ';
                
                title.innerHTML = winnerText;
                
                body.innerHTML = `
                    <div style="text-align: center; margin-bottom: 20px;">
                        <strong>ÁµÇÂ±ÄÂéüÂõ†Ôºö</strong>${reason}
                    </div>
                    <div style="background: #f5f6fa; padding: 20px; border-radius: 12px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                            <div>
                                <div style="font-size: 0.9em; color: #636e72; margin-bottom: 5px;">ÈªëÊ£ãÁ∏ΩÂàÜ</div>
                                <div style="font-size: 2em; font-weight: 700; color: #2d3436;">${result.blackTotal}</div>
                                <div style="font-size: 0.85em; color: #636e72;">Ê¥ªÊ£ã ${result.blackStones} + ÂúçÂú∞ ${result.blackTerritory}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.9em; color: #636e72; margin-bottom: 5px;">ÁôΩÊ£ãÁ∏ΩÂàÜ</div>
                                <div style="font-size: 2em; font-weight: 700; color: #2d3436;">${result.whiteTotal}</div>
                                <div style="font-size: 0.85em; color: #636e72;">Ê¥ªÊ£ã ${result.whiteStones} + ÂúçÂú∞ ${result.whiteTerritory}</div>
                            </div>
                        </div>
                        <div style="text-align: center; padding-top: 15px; border-top: 2px solid #dfe6e9;">
                            <strong>ÂàÜÂ∑ÆÔºö${result.margin} ÁõÆ</strong><br>
                            <span style="font-size: 0.85em; color: #636e72;">‰πùË∑ØÊ£ãÁõ§ÂÖ±81ÁõÆÔºå‚â•41ÁõÆÁç≤Âãù</span>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 20px; font-size: 0.9em; color: #636e72;">
                        Á∏ΩÂõûÂêàÊï∏Ôºö${this.moveCount} Êâã<br>
                        ÊèêÂ≠êÊï∏ÔºöÈªë ${this.blackCaptures} : ÁôΩ ${this.whiteCaptures}
                    </div>
                `;
                
                modal.classList.add('active');
            }

            updateScores() {
                // ÂØ¶ÊôÇË®àÂàÜ
                let blackStones = 0, whiteStones = 0;
                
                for (let r = 0; r < 9; r++) {
                    for (let c = 0; c < 9; c++) {
                        if (this.board[r][c] === 1) blackStones++;
                        else if (this.board[r][c] === -1) whiteStones++;
                    }
                }
                
                // Á∞°ÂñÆÂúçÂú∞‰º∞ÁÆóÔºàÂÉÖÁî®ÊñºÂç≥ÊôÇÈ°ØÁ§∫Ôºâ
                const visited = Array(9).fill().map(() => Array(9).fill(false));
                let blackTerritory = 0, whiteTerritory = 0;
                
                for (let r = 0; r < 9; r++) {
                    for (let c = 0; c < 9; c++) {
                        if (this.board[r][c] === 0 && !visited[r][c]) {
                            const territory = this.calculateTerritory(r, c, visited);
                            if (territory.owner === 1) blackTerritory += territory.size;
                            else if (territory.owner === -1) whiteTerritory += territory.size;
                        }
                    }
                }
                
                document.getElementById('blackScore').textContent = blackStones + blackTerritory;
                document.getElementById('whiteScore').textContent = whiteStones + whiteTerritory;
                document.getElementById('blackStones').textContent = blackStones;
                document.getElementById('whiteStones').textContent = whiteStones;
                document.getElementById('blackTerritory').textContent = blackTerritory;
                document.getElementById('whiteTerritory').textContent = whiteTerritory;
                document.getElementById('moveCount').textContent = this.moveCount;
                document.getElementById('blackCaptures').textContent = this.blackCaptures;
                document.getElementById('whitCaptures').textContent = this.whiteCaptures;
            }

            undoMove() {
                if (this.moveHistory.length === 0 || this.gameOver) return;
                
                const lastState = this.moveHistory.pop();
                if (this.moveHistory.length > 0) {
                    const prevState = this.moveHistory[this.moveHistory.length - 1];
                    this.board = prevState.board.map(r => [...r]);
                    this.blackCaptures = prevState.blackCaptures;
                    this.whiteCaptures = prevState.whiteCaptures;
                } else {
                    this.board = Array(9).fill().map(() => Array(9).fill(0));
                    this.blackCaptures = 0;
                    this.whiteCaptures = 0;
                }
                
                this.moveCount = Math.max(0, this.moveCount - 1);
                this.currentPlayer = lastState.player;
                this.consecutivePasses = 0;
                this.updatePassButton();
                this.lastMove = null;
                
                this.updateBoardDisplay();
                this.updateScores();
                this.updateStatus();
                this.checkAtari();
            }
        }

        let game;

        function newGame() {
            document.getElementById('passBtn').textContent = '‚è≠ ËÆìÂ≠ê (0/2)';
            document.getElementById('undoBtn').disabled = false;
            document.getElementById('passBtn').disabled = false;
            closeModal();
            game = new NineBoardGo();
        }

        function toggleAI() {
            if (!game) return;
            game.aiEnabled = !game.aiEnabled;
            document.getElementById('aiBtn').textContent = game.aiEnabled ? 'ü§ñ AI: ÈñãÂïü' : 'ü§ñ AI: ÈóúÈñâ';
        }

        function closeModal() {
            document.getElementById('gameOverModal').classList.remove('active');
        }

        window.onload = () => {
            newGame();
        };

        // Èò≤Ê≠¢ÊÑèÂ§ñÈóúÈñâ
        window.addEventListener('beforeunload', (e) => {
            if (game && game.moveCount > 0 && !game.gameOver) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>
